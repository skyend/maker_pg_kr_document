<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>データベースファイルのレイアウト</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version "><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 9.1.4文書"
HREF="index.html"><LINK
REL="UP"
TITLE="データベースの物理的な格納"
HREF="storage.html"><LINK
REL="PREVIOUS"
TITLE="データベースの物理的な格納"
HREF="storage.html"><LINK
REL="NEXT"
TITLE="TOAST"
HREF="storage-toast.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=euc-jp"><META
NAME="creation"
CONTENT="2012-06-16T03:12:10"></HEAD
><BODY
CLASS="SECT1"
><script type="text/javascript">
var mod_layout = 'test';
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-50659-6");
pageTracker._trackPageview();
</script>
<style>
body{margin:0;}
#lay_body{margin:8px;}
#lay_header{margin:0 0 4px 0;border:0;padding:0;}
#lay_header .b1{border-bottom:#cef solid 1px;}
#lay_header .b2{border-bottom:#8df solid 1px;}
#lay_header .b3{border-bottom:#4bf solid 1px;padding:5px 5px 3px 5px;background:#0af;text-align:center;color:#fff;}
#lay_header a{text-decoration:none;color:#fff;font-weight:bold;}
#lay_header a:hover{text-decoration:underline;}
</style>
<div id="lay_header"><div class="b1"><div class="b2"><div class="b3">
<a href="http://lets.postgresql.jp/" target="_blank">PostgreSQLポータルサイト ＜Let's Postgres＞ http://lets.postgresql.jp/</a><br>
入門から運用、チューニングノウハウ、新機能の解説など、幅広い内容の技術解説記事をお読みいただけます。
</div></div></div></div>
<div id="lay_body">
<DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="5"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>PostgreSQL 9.1.4文書</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="データベースの物理的な格納"
HREF="storage.html"
ACCESSKEY="P"
>&#21069;&#12398;&#12506;&#12540;&#12472;</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="データベースの物理的な格納"
HREF="storage.html"
>&#24059;&#25147;&#12375;</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>&#31532; 55&#31456;データベースの物理的な格納</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="top"
><A
TITLE="データベースの物理的な格納"
HREF="storage.html"
>&#26089;&#36865;&#12426;</A
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="top"
><A
TITLE="TOAST"
HREF="storage-toast.html"
ACCESSKEY="N"
>&#27425;&#12398;&#12506;&#12540;&#12472;</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="STORAGE-FILE-LAYOUT"
>55.1. データベースファイルのレイアウト</A
></H1
><P
>本節ではファイルとディレクトリというレベルで格納書式について説明します。</P
><P
>データベースクラスタで必要となるすべてのデータは、クラスタのデータディレクトリ内に格納され、通常（このディレクトリを定義するために使用できる環境変数名にちなんで）<TT
CLASS="VARNAME"
>PGDATA</TT
>として参照されます。
通常の<TT
CLASS="VARNAME"
>PGDATA</TT
>の位置は<TT
CLASS="FILENAME"
>/var/lib/pgsql/data</TT
>です。
異なるサーバインスタンスによって管理することで、複数のクラスタを同一のマシン上に存在させることができます。</P
><P
><A
HREF="storage-file-layout.html#PGDATA-CONTENTS-TABLE"
>&#34920;55-1</A
>に示すように、<TT
CLASS="VARNAME"
>PGDATA</TT
>ディレクトリには数個のサブディレクトリと制御ファイルがあります。
これら必要な項目に加え、クラスタの設定ファイルである<TT
CLASS="FILENAME"
>postgresql.conf</TT
>、<TT
CLASS="FILENAME"
>pg_hba.conf</TT
>および<TT
CLASS="FILENAME"
>pg_ident.conf</TT
>が伝統的に<TT
CLASS="VARNAME"
>PGDATA</TT
>内に格納されます
（ただし<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> 8.0以降では他の場所にも保存できます）。</P
><DIV
CLASS="TABLE"
><A
NAME="PGDATA-CONTENTS-TABLE"
></A
><P
><B
>&#34920; 55-1. <TT
CLASS="VARNAME"
>PGDATA</TT
>の内容</B
></P
><TABLE
BORDER="1"
CLASS="CALSTABLE"
><COL><COL><THEAD
><TR
><TH
>項目</TH
><TH
>説明</TH
></TR
></THEAD
><TBODY
><TR
><TD
><TT
CLASS="FILENAME"
>PG_VERSION</TT
></TD
><TD
><SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>の主バージョン番号を保有するファイル</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>base</TT
></TD
><TD
>データベースごとのサブディレクトリを保有するサブディレクトリ</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>global</TT
></TD
><TD
><TT
CLASS="STRUCTNAME"
>pg_database</TT
>のようなクラスタで共有するテーブルを保有するサブディレクトリ</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>pg_clog</TT
></TD
><TD
>トランザクションのコミット状態のデータを保有するサブディレクトリ</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>pg_multixact</TT
></TD
><TD
>マルチトランザクションの状態のデータを保有するサブディレクトリ（共有行ロックで使用されます）</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>pg_notify</TT
></TD
><TD
>LISTEN/NOTIFY状態データを保有するサブディレクトリ</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>pg_serial</TT
></TD
><TD
>コミットされたシリアライザブルトランザクションに関する情報を保有するサブディレクトリ</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>pg_stat_tmp</TT
></TD
><TD
>統計用サブシステム用の一時ファイルを保有するサブディレクトリ</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>pg_subtrans</TT
></TD
><TD
>サブトランザクションの状態のデータを保有するサブディレクトリ</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>pg_tblspc</TT
></TD
><TD
>テーブル空間へのシンボリックリンクを保有するサブディレクトリ</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>pg_twophase</TT
></TD
><TD
>プリペアドトランザクション用の状態ファイルを保有するサブディレクトリ</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>pg_xlog</TT
></TD
><TD
> WAL（ログ先行書き込み）ファイルを保有するサブディレクトリ</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>postmaster.opts</TT
></TD
><TD
>最後にサーバを起動した時のコマンドラインオプションを記録するファイル</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>postmaster.pid</TT
></TD
><TD
>現在のpostmasterプロセスID（PID）、クラスタのデータディレクトリパス、postmaster起動時のタイムスタンプ、ポート番号、Unixドメインソケットのディレクトリパス（Windowsでは空）、有効な監視アドレスの一番目（IPアドレスまたは<TT
CLASS="LITERAL"
>*</TT
>、TCPを監視していない場合は空）および共有メモリのセグメントIDを記録するロックファイル（サーバが停止した後は存在しません）</TD
></TR
></TBODY
></TABLE
></DIV
><P
>クラスタ内の各データベースに対して、<TT
CLASS="VARNAME"
>PGDATA</TT
><TT
CLASS="FILENAME"
>/base</TT
>内にサブディレクトリが存在し、サブディレクトリ名は<TT
CLASS="STRUCTNAME"
>pg_database</TT
>内のデータベースOIDとなります。
このサブディレクトリはデータベースファイルのデフォルトの位置であり、特にシステムカタログがそこに格納されます。</P
><P
>各テーブルおよびインデックスは別個のファイルに格納されます。
通常のリレーションでは、これらのファイル名はテーブルまたはインデックスの<I
CLASS="FIRSTTERM"
>ファイルノード</I
>番号となります。
ファイルノード番号は<TT
CLASS="STRUCTNAME"
>pg_class</TT
>.<TT
CLASS="STRUCTFIELD"
>relfilenode</TT
>内で見つけられます。
しかし一時的なリレーションでは、ファイル名は<TT
CLASS="LITERAL"
>t<TT
CLASS="REPLACEABLE"
><I
>BBB</I
></TT
>_<TT
CLASS="REPLACEABLE"
><I
>FFF</I
></TT
></TT
>という形になります。
ここで<TT
CLASS="REPLACEABLE"
><I
>BBB</I
></TT
>はファイルを生成したバックエンドのバックエンドID、<TT
CLASS="REPLACEABLE"
><I
>FFF</I
></TT
>はファイルノード番号です。
どちらの場合でも、主ファイル（いわゆる主フォーク）に加え、それぞれのテーブルとインデックスはリレーションに利用できる空き領域についての情報を格納する<I
CLASS="FIRSTTERM"
>空き領域マップ</I
>（<A
HREF="storage-fsm.html"
>&#38917;55.3</A
>参照）を持ちます。
空き領域マップはファイルノード番号に接尾辞<TT
CLASS="LITERAL"
>_fsm</TT
>がついた名前のファイルに格納されます。
テーブルは同時に、どのページが不要なタプルを持っていないと判断できるように追跡する<I
CLASS="FIRSTTERM"
>可視性マップ</I
>を持ち、フォークに接尾辞<TT
CLASS="LITERAL"
>_vm</TT
>を付けたファイルに格納します。
可視性マップは<A
HREF="storage-vm.html"
>&#38917;55.4</A
>でより詳しく解説します。
ログを取らないテーブルとインデックスは、初期化フォークという第３のフォークを持ち、フォークに接尾辞<TT
CLASS="LITERAL"
>_init</TT
>を付けたファイルに格納します（<A
HREF="storage-init.html"
>&#38917;55.5</A
>参照）。</P
><DIV
CLASS="CAUTION"
><P
></P
><TABLE
CLASS="CAUTION"
BORDER="1"
WIDTH="100%"
><TR
><TD
ALIGN="CENTER"
><B
>&#27880;&#24847;</B
></TD
></TR
><TR
><TD
ALIGN="LEFT"
><P
>テーブルにおけるファイルノード番号とOIDは多くの場合一致しますが、常に一致するとは<SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>限らない</I
></SPAN
>ことに注意してください。
<TT
CLASS="COMMAND"
>TRUNCATE</TT
>、<TT
CLASS="COMMAND"
>REINDEX</TT
>、<TT
CLASS="COMMAND"
>CLUSTER</TT
>等のいくつかの操作、および<TT
CLASS="COMMAND"
>ALTER TABLE</TT
>におけるいくつかの構文は、OIDを保持したままファイルノード番号を変更できます。
ファイルノード番号とテーブルOIDが同一であると仮定しないでください。
また<TT
CLASS="STRUCTNAME"
>pg_class</TT
>自身を含む特定のシステムカタログにおいて、<TT
CLASS="STRUCTNAME"
>pg_class</TT
>.<TT
CLASS="STRUCTFIELD"
>relfilenode</TT
>はゼロを持ちます。
これらのカタログの実際のファイルノード番号は低レベルなデータ構造内に保管されており、<CODE
CLASS="FUNCTION"
>pg_relation_filenode()</CODE
>関数を使用して入手できます。</P
></TD
></TR
></TABLE
></DIV
><P
>テーブルまたはインデックスが１ギガバイトを超えると、ギガバイト単位の<I
CLASS="FIRSTTERM"
>セグメント</I
>に分割されます。
最初のセグメントのファイル名はファイルノード番号と同一であり、それ以降は、ファイルノード番号.1、ファイルノード番号.2等の名称になります。
この配置法によってファイル容量に制限のあるプラットフォームにおける問題を回避します。
（実際、１ギガバイトは単なるデフォルトのセグメント容量です。
セグメント容量は<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>を構築する際、<TT
CLASS="OPTION"
>--with-segsize</TT
>設定オプションを使用して調整することができます。)
原理上、空き領域マップと可視性マップのフォークにおいても複数のセグメントも必要とする可能性がありますが、実際のところは起こりそうにありません。</P
><P
>項目が大きくなりそうな列を持ったテーブルは、連携した<I
CLASS="FIRSTTERM"
>TOAST</I
>テーブルを保有する可能性があります。
<I
CLASS="FIRSTTERM"
>TOAST</I
>テーブルは、テーブル行の中には大き過ぎて適切に保持できないフィールド値を行の外部に格納するために使用されます。
<ACRONYM
CLASS="ACRONYM"
>TOAST</ACRONYM
>テーブルが存在する時、<TT
CLASS="STRUCTNAME"
>pg_class</TT
>.<TT
CLASS="STRUCTFIELD"
>reltoastrelid</TT
>は元のテーブルと<ACRONYM
CLASS="ACRONYM"
>TOAST</ACRONYM
>テーブルを結びつけます。
<A
HREF="storage-toast.html"
>&#38917;55.2</A
>を参照してください。</P
><P
>テーブルおよびインデックスの内容は、<A
HREF="storage-page-layout.html"
>&#38917;55.6</A
>においてさらに考察されています。</P
><P
>テーブル空間は状況をさらに複雑にします。
ユーザが定義したテーブル空間はそれぞれ、<TT
CLASS="VARNAME"
>PGDATA</TT
><TT
CLASS="FILENAME"
>/pg_tblspc</TT
>ディレクトリ内に物理的なテーブル空間ディレクトリ（つまりそのテーブル空間の<TT
CLASS="COMMAND"
>CREATE TABLESPACE</TT
>コマンドで指定された場所）を指し示す、シンボリックリンクを持ちます。
シンボリックリンクの名称はテーブル空間のOIDとなります。
物理的テーブル空間ディレクトリの内部では、<TT
CLASS="LITERAL"
>PG_9.0_201008051</TT
>などの<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>サーバのバージョンに依存した名前のサブディレクトリが存在します。
（このサブディレクトリを使用する理由は、競合することなく<TT
CLASS="COMMAND"
>CREATE TABLESPACE</TT
>で指定する場所と同じものを将来のバージョンのデータベースでも使用できるようにするためです。）
このバージョン固有のサブディレクトリの内部では、テーブル空間に要素を持つデータベースごとに、データベースOIDをディレクトリ名としたサブディレクトリが存在します。
テーブルとインデックスは、ファイルノードの命名の規定に従って、そのディレクトリ内に格納されます。
<TT
CLASS="LITERAL"
>pg_default</TT
>テーブル空間は <TT
CLASS="FILENAME"
>pg_tblspc</TT
>を通してアクセスされるのではなく、<TT
CLASS="VARNAME"
>PGDATA</TT
><TT
CLASS="FILENAME"
>/base</TT
>と連携します。
同様に、<TT
CLASS="LITERAL"
>pg_global</TT
>テーブル空間は<TT
CLASS="FILENAME"
>pg_tblspc</TT
>を通してアクセスされるのではなく、<TT
CLASS="VARNAME"
>PGDATA</TT
><TT
CLASS="FILENAME"
>/global</TT
>と連携します。</P
><P
><CODE
CLASS="FUNCTION"
>pg_relation_filepath()</CODE
>関数は任意のリレーションの(<TT
CLASS="VARNAME"
>PGDATA</TT
>から相対的な)パス全体を示します。
これは上の規則の多くを記憶する必要がありませんので、しばしば有用です。
しかし、この関数がリレーションの主フォークの最初のセグメントの名前だけを返すことに注意して下さい。
リレーションに関したすべてのファイルを見つけるためにセグメント番号や<TT
CLASS="LITERAL"
>_fsm</TT
>や<TT
CLASS="LITERAL"
>_vm</TT
>を追加する必要があるかもしれません。</P
><P
>一時ファイル（メモリ内に収まりきらないデータのソートなどの操作用）は<TT
CLASS="VARNAME"
>PGDATA</TT
><TT
CLASS="FILENAME"
>/base/pgsql_tmp</TT
>内、または、<TT
CLASS="LITERAL"
>pg_default</TT
>以外のテーブル空間が指定されていた場合はテーブル空間ディレクトリ下の<TT
CLASS="FILENAME"
>pgsql_tmp</TT
>サブディレクトリ内に作成されます。
一時ファイルの名前は<TT
CLASS="FILENAME"
>pgsql_tmp<TT
CLASS="REPLACEABLE"
><I
>PPP</I
></TT
>.<TT
CLASS="REPLACEABLE"
><I
>NNN</I
></TT
></TT
>という形式です。
ここで、<TT
CLASS="REPLACEABLE"
><I
>PPP</I
></TT
>は所有するバックエンドのPIDであり、<TT
CLASS="REPLACEABLE"
><I
>NNN</I
></TT
>で同一バックエンドで作成された別の一時ファイルと区別します。</P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="storage.html"
ACCESSKEY="P"
>&#21069;&#12398;&#12506;&#12540;&#12472;</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>&#12507;&#12540;&#12512;</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="storage-toast.html"
ACCESSKEY="N"
>&#27425;&#12398;&#12506;&#12540;&#12472;</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>データベースの物理的な格納</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="storage.html"
ACCESSKEY="U"
>&#19978;&#12395;&#25147;&#12427;</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>TOAST</TD
></TR
></TABLE
></DIV
></BODY
></HTML
></div>
