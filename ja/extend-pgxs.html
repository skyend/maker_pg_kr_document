<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>拡張構築基盤</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version "><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 9.1.4文書"
HREF="index.html"><LINK
REL="UP"
TITLE="SQLの拡張"
HREF="extend.html"><LINK
REL="PREVIOUS"
TITLE="関連するオブジェクトを拡張としてパッケージ化"
HREF="extend-extensions.html"><LINK
REL="NEXT"
TITLE="トリガ"
HREF="triggers.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=euc-jp"><META
NAME="creation"
CONTENT="2012-06-16T03:12:10"></HEAD
><BODY
CLASS="SECT1"
><script type="text/javascript">
var mod_layout = 'test';
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-50659-6");
pageTracker._trackPageview();
</script>
<style>
body{margin:0;}
#lay_body{margin:8px;}
#lay_header{margin:0 0 4px 0;border:0;padding:0;}
#lay_header .b1{border-bottom:#cef solid 1px;}
#lay_header .b2{border-bottom:#8df solid 1px;}
#lay_header .b3{border-bottom:#4bf solid 1px;padding:5px 5px 3px 5px;background:#0af;text-align:center;color:#fff;}
#lay_header a{text-decoration:none;color:#fff;font-weight:bold;}
#lay_header a:hover{text-decoration:underline;}
</style>
<div id="lay_header"><div class="b1"><div class="b2"><div class="b3">
<a href="http://lets.postgresql.jp/" target="_blank">PostgreSQLポータルサイト ＜Let's Postgres＞ http://lets.postgresql.jp/</a><br>
入門から運用、チューニングノウハウ、新機能の解説など、幅広い内容の技術解説記事をお読みいただけます。
</div></div></div></div>
<div id="lay_body">
<DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="5"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>PostgreSQL 9.1.4文書</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="関連するオブジェクトを拡張としてパッケージ化"
HREF="extend-extensions.html"
ACCESSKEY="P"
>&#21069;&#12398;&#12506;&#12540;&#12472;</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="SQLの拡張"
HREF="extend.html"
>&#24059;&#25147;&#12375;</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>&#31532; 35&#31456;<ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>の拡張</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="top"
><A
TITLE="SQLの拡張"
HREF="extend.html"
>&#26089;&#36865;&#12426;</A
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="top"
><A
TITLE="トリガ"
HREF="triggers.html"
ACCESSKEY="N"
>&#27425;&#12398;&#12506;&#12540;&#12472;</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="EXTEND-PGXS"
>35.16. 拡張構築基盤</A
></H1
><P
><SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>拡張モジュールの配布を考えているのであれば、移植可能な構築システムを準備することはかなり難しいものになるかもしれません。
このため<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>インストレーションは単純な拡張モジュールをすでにインストールされているサーバに対して簡単に構築することができるように、<ACRONYM
CLASS="ACRONYM"
>PGXS</ACRONYM
>と呼ばれる拡張向けの構築基盤を提供します。
<ACRONYM
CLASS="ACRONYM"
>PGXS</ACRONYM
>は主にCコードを含む拡張を意図していますが、SQLのみからなる拡張でも使用することができます。
<ACRONYM
CLASS="ACRONYM"
>PGXS</ACRONYM
>が<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>と相互に作用する任意のソフトウェアを構築するために使用できるような万能な構築システムを意図したものではないことに注意してください。
これは単に、単純なサーバ拡張用の一般的な構築規則を自動化するものです。
より複雑なパッケージでは、独自の構築システムを作成する必要があるかもしれません。
   </P
><P
>独自の拡張で<ACRONYM
CLASS="ACRONYM"
>PGXS</ACRONYM
>基盤を使用するためには、簡単なメークファイルを作成する必要があります。
このメークファイルの中で、いくつか変数を設定し、最後に大域的な<ACRONYM
CLASS="ACRONYM"
>PGXS</ACRONYM
>メークファイルをインクルードする必要があります。
以下に<TT
CLASS="LITERAL"
>isbn_issn</TT
>という名称の拡張モジュールを構築する例を示します。
このモジュールはいくつかのCコードを含む共有ライブラリ、拡張の制御ファイル、SQLスクリプト、ドキュメントテキストファイルから構成されます。
</P><PRE
CLASS="PROGRAMLISTING"
>MODULES = isbn_issn
EXTENSION = isbn_issn
DATA = isbn_issn--1.0.sql
DOCS = README.isbn_issn

PG_CONFIG = pg_config
PGXS := $(shell $(PG_CONFIG) --pgxs)
include $(PGXS)</PRE
><P>
最後の３行は常に同じです。
ファイルのこの前に変数の設定と独自の<SPAN
CLASS="APPLICATION"
>make</SPAN
>ルールを記載してください。
   </P
><P
>以下の３個の変数の１つを構築対象に指定してください。

    <P
></P
></P><DIV
CLASS="VARIABLELIST"
><DL
><DT
><TT
CLASS="VARNAME"
>MODULES</TT
></DT
><DD
><P
>同じ家系のソースファイルから構築される共有ライブラリのリストです。
（このリストにはライブラリ接頭辞を含めないでください。）
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>MODULE_big</TT
></DT
><DD
><P
>複数のソースファイルから構築される共有ライブラリです。
（<TT
CLASS="VARNAME"
>OBJS</TT
>にオブジェクトファイルを列挙します。）
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>PROGRAM</TT
></DT
><DD
><P
>構築する実行プログラムです。
（<TT
CLASS="VARNAME"
>OBJS</TT
>にオブジェクトファイルを列挙します。）
       </P
></DD
></DL
></DIV
><P>

以下の変数も設定することができます。

    <P
></P
></P><DIV
CLASS="VARIABLELIST"
><DL
><DT
><TT
CLASS="VARNAME"
>EXTENSION</TT
></DT
><DD
><P
>拡張の名前です。
各名前に対して、<TT
CLASS="LITERAL"
><TT
CLASS="REPLACEABLE"
><I
>prefix</I
></TT
>/share/extension</TT
>にインストールされる<TT
CLASS="LITERAL"
><TT
CLASS="REPLACEABLE"
><I
>extension</I
></TT
>.control</TT
>を提供しなければなりません。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>MODULEDIR</TT
></DT
><DD
><P
>DATAおよびDOCSファイルのインストール先となるはずの<TT
CLASS="LITERAL"
><TT
CLASS="REPLACEABLE"
><I
>prefix</I
></TT
>/share</TT
>副ディレクトリです。
（設定がない場合、デフォルトは<TT
CLASS="VARNAME"
>EXTENSION</TT
>が設定されている場合は<TT
CLASS="LITERAL"
>extension</TT
>に、設定されていない場合は<TT
CLASS="LITERAL"
>contrib</TT
>になります。）
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>DATA</TT
></DT
><DD
><P
><TT
CLASS="LITERAL"
><TT
CLASS="REPLACEABLE"
><I
>prefix</I
></TT
>/share/$MODULEDIR</TT
>にインストールされる様々なファイルです。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>DATA_built</TT
></DT
><DD
><P
><TT
CLASS="LITERAL"
><TT
CLASS="REPLACEABLE"
><I
>prefix</I
></TT
>/share/$MODULEDIR</TT
>にインストールされる、最初に構築しなければならない様々なファイルです。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>DATA_TSEARCH</TT
></DT
><DD
><P
><TT
CLASS="LITERAL"
><TT
CLASS="REPLACEABLE"
><I
>prefix</I
></TT
>/share/tsearch_data</TT
>以下にインストールされる様々なファイルです。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>DOCS</TT
></DT
><DD
><P
><TT
CLASS="LITERAL"
><TT
CLASS="REPLACEABLE"
><I
>prefix</I
></TT
>/doc/$MODULEDIR</TT
>以下にインストールされる様々なファイルです。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>SCRIPTS</TT
></DT
><DD
><P
><TT
CLASS="LITERAL"
><TT
CLASS="REPLACEABLE"
><I
>prefix</I
></TT
>/bin</TT
>にインストールされるスクリプトファイルです（バイナリファイルではありません）。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>SCRIPTS_built</TT
></DT
><DD
><P
><TT
CLASS="LITERAL"
><TT
CLASS="REPLACEABLE"
><I
>prefix</I
></TT
>/bin</TT
>にインストールされる、最初に構築しなければならないスクリプトファイルです（バイナリファイルではありません）。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>REGRESS</TT
></DT
><DD
><P
>リグレッション試験ケース（接尾辞がない）のリストです。
後述します。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>REGRESS_OPTS</TT
></DT
><DD
><P
><SPAN
CLASS="APPLICATION"
>pg_regress</SPAN
>に渡す追加オプションです。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>EXTRA_CLEAN</TT
></DT
><DD
><P
><TT
CLASS="LITERAL"
>make clean</TT
>で削除される追加ファイルです。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>PG_CPPFLAGS</TT
></DT
><DD
><P
><TT
CLASS="VARNAME"
>CPPFLAGS</TT
>に追加されます。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>PG_LIBS</TT
></DT
><DD
><P
><TT
CLASS="VARNAME"
>PROGRAM</TT
>のリンク行に追加されます。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>SHLIB_LINK</TT
></DT
><DD
><P
><TT
CLASS="VARNAME"
>MODULE_big</TT
>リンク行に追加されます。
       </P
></DD
><DT
><TT
CLASS="VARNAME"
>PG_CONFIG</TT
></DT
><DD
><P
>構築対象の<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>インストレーション用の<SPAN
CLASS="APPLICATION"
>pg_config</SPAN
>プログラムへのパスです。
（通常は<TT
CLASS="VARNAME"
>PATH</TT
>内の最初に見つかる<TT
CLASS="LITERAL"
>pg_config</TT
>が単純に使用されます）
       </P
></DD
></DL
></DIV
><P>
   </P
><P
>このメークファイルを<TT
CLASS="LITERAL"
>Makefile</TT
>として拡張を保管するディレクトリ内に保管してください。
その後コンパイルするために<TT
CLASS="LITERAL"
>make</TT
>を、モジュールをインストールするために<TT
CLASS="LITERAL"
>make install</TT
>を行うことができます。
デフォルトでは、<TT
CLASS="VARNAME"
>PATH</TT
>の中で最初に見つかる<TT
CLASS="COMMAND"
>pg_config</TT
>プログラムが対応する<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>インストレーション用に拡張はコンパイルされ、インストールされます。
メークファイルまたは<TT
CLASS="LITERAL"
>make</TT
>のコマンドラインのいずれかで<TT
CLASS="VARNAME"
>PG_CONFIG</TT
>を別の<TT
CLASS="COMMAND"
>pg_config</TT
>プログラムを指し示すように設定することで、別のインストレーションを使用することができます。
   </P
><DIV
CLASS="CAUTION"
><P
></P
><TABLE
CLASS="CAUTION"
BORDER="1"
WIDTH="100%"
><TR
><TD
ALIGN="CENTER"
><B
>&#27880;&#24847;</B
></TD
></TR
><TR
><TD
ALIGN="LEFT"
><P
><TT
CLASS="VARNAME"
>PG_CONFIG</TT
>の変更は、<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> 8.3以降に対して構築する場合にのみ動作します。
より古いリリースでは、<TT
CLASS="LITERAL"
>pg_config</TT
>以外の何かを設定しても動作しません。
構築対象のインストレーションを選択するように<TT
CLASS="VARNAME"
>PATH</TT
>を変更しなければなりません。
    </P
></TD
></TR
></TABLE
></DIV
><P
><TT
CLASS="VARNAME"
>REGRESS</TT
>変数に列挙されたスクリプトは、<TT
CLASS="LITERAL"
>make install</TT
>を実行した後で<TT
CLASS="LITERAL"
>make installcheck</TT
>によって呼び出すことができる、作成したモジュールのリグレッション試験で使用されます。
これが動作するためには、<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>サーバが実行していなければなりません。
<TT
CLASS="VARNAME"
>REGRESS</TT
>変数に列挙されたスクリプトは、拡張のディレクトリ内の<TT
CLASS="LITERAL"
>sql/</TT
>という名前の副ディレクトリ内に存在しなければなりません。
これらのファイルは<TT
CLASS="LITERAL"
>.sql</TT
>という拡張子を持たなければなりません。
この拡張子はメークファイル内の<TT
CLASS="VARNAME"
>REGRESS</TT
>リストには含まれません。
また試験ごとに<TT
CLASS="LITERAL"
>expected/</TT
>という名前の副ディレクトリ内に想定出力を内容として含む、同じステムに<TT
CLASS="LITERAL"
>.out</TT
>拡張子を付けた名前のファイルがなければなりません。
<TT
CLASS="LITERAL"
>make installcheck</TT
>は<SPAN
CLASS="APPLICATION"
>psql</SPAN
>を用いて各試験スクリプトを実行し、結果出力が想定ファイルに一致するかどうか比較します。
何らかの差異は<TT
CLASS="COMMAND"
>diff -c</TT
>書式で<TT
CLASS="LITERAL"
>regression.diffs</TT
>に書き出されます。
想定ファイルがない試験を実行しようとすると<SPAN
CLASS="QUOTE"
>"問題"</SPAN
>として報告されます。
このためすべての想定ファイルがあることを確認してください。
   </P
><DIV
CLASS="TIP"
><BLOCKQUOTE
CLASS="TIP"
><P
><B
>&#12486;&#12451;&#12483;&#12503;: </B
>想定ファイルを作成する最も簡単な方法は、空のファイルを作成し、試験を実行する（当然差異が報告されます）ことです。
<TT
CLASS="LITERAL"
>results/</TT
>ディレクトリ内で見つかる実際の結果ファイルを確認し、テストの想定結果と合致するのであれば、<TT
CLASS="LITERAL"
>expected/</TT
>にコピーしてください。
    </P
></BLOCKQUOTE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="extend-extensions.html"
ACCESSKEY="P"
>&#21069;&#12398;&#12506;&#12540;&#12472;</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>&#12507;&#12540;&#12512;</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="triggers.html"
ACCESSKEY="N"
>&#27425;&#12398;&#12506;&#12540;&#12472;</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>関連するオブジェクトを拡張としてパッケージ化</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="extend.html"
ACCESSKEY="U"
>&#19978;&#12395;&#25147;&#12427;</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>トリガ</TD
></TR
></TABLE
></DIV
></BODY
></HTML
></div>
