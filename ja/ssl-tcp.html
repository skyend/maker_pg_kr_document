<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>SSLによる安全なTCP/IP接続</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version "><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 9.1.4文書"
HREF="index.html"><LINK
REL="UP"
TITLE="サーバの準備と運用"
HREF="runtime.html"><LINK
REL="PREVIOUS"
TITLE="暗号化オプション"
HREF="encryption-options.html"><LINK
REL="NEXT"
TITLE="SSHトンネルを使った安全なTCP/IP接続"
HREF="ssh-tunnels.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=euc-jp"><META
NAME="creation"
CONTENT="2012-06-16T03:12:10"></HEAD
><BODY
CLASS="SECT1"
><script type="text/javascript">
var mod_layout = 'test';
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-50659-6");
pageTracker._trackPageview();
</script>
<style>
body{margin:0;}
#lay_body{margin:8px;}
#lay_header{margin:0 0 4px 0;border:0;padding:0;}
#lay_header .b1{border-bottom:#cef solid 1px;}
#lay_header .b2{border-bottom:#8df solid 1px;}
#lay_header .b3{border-bottom:#4bf solid 1px;padding:5px 5px 3px 5px;background:#0af;text-align:center;color:#fff;}
#lay_header a{text-decoration:none;color:#fff;font-weight:bold;}
#lay_header a:hover{text-decoration:underline;}
</style>
<div id="lay_header"><div class="b1"><div class="b2"><div class="b3">
<a href="http://lets.postgresql.jp/" target="_blank">PostgreSQLポータルサイト ＜Let's Postgres＞ http://lets.postgresql.jp/</a><br>
入門から運用、チューニングノウハウ、新機能の解説など、幅広い内容の技術解説記事をお読みいただけます。
</div></div></div></div>
<div id="lay_body">
<DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="5"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>PostgreSQL 9.1.4文書</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="暗号化オプション"
HREF="encryption-options.html"
ACCESSKEY="P"
>&#21069;&#12398;&#12506;&#12540;&#12472;</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="サーバの準備と運用"
HREF="runtime.html"
>&#24059;&#25147;&#12375;</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>&#31532; 17&#31456;サーバの準備と運用</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="top"
><A
TITLE="サーバの準備と運用"
HREF="runtime.html"
>&#26089;&#36865;&#12426;</A
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="top"
><A
TITLE="SSHトンネルを使った安全なTCP/IP接続"
HREF="ssh-tunnels.html"
ACCESSKEY="N"
>&#27425;&#12398;&#12506;&#12540;&#12472;</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="SSL-TCP"
>17.9. SSLによる安全なTCP/IP接続</A
></H1
><P
><SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>は標準で<ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>接続をサポートし、クライアント/サーバの通信がさらに安全になるよう暗号化します。
そのためには<SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>がクライアントとサーバシステムの両方にインストールされ、構築時に<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>におけるそのサポートが有効になっている必要があります（<A
HREF="installation.html"
>&#31532;15&#31456;</A
>を参照してください）。
  </P
><P
><ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>サポートを有効にしてコンパイルされた場合、<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>サーバは、<TT
CLASS="FILENAME"
>postgresql.conf</TT
>において<A
HREF="runtime-config-connection.html#GUC-SSL"
>ssl</A
>パラメータを<TT
CLASS="LITERAL"
>on</TT
>にすることで、<ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>サポートを有効にして起動することができます。
サーバは同じTCPポートで通常の接続と<ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>接続の両方を待ち受け、クライアントとの接続に<ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>を使用するかどうかを調停します。
デフォルトでは、これはクライアント側の選択肢です。
一部またはすべての接続で<ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>の使用を必要とさせるためのサーバ側の設定方法に関しては<A
HREF="auth-pg-hba-conf.html"
>&#38917;19.1</A
>を参照してください。
  </P
><P
><SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>は、システム全体用の<SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>設定ファイルを読み取ります。
デフォルトでは、このファイルの名前は<TT
CLASS="FILENAME"
>openssl.cnf</TT
>であり、<TT
CLASS="LITERAL"
>openssl version -d</TT
>で報告されるディレクトリに存在します。
このデフォルトは、環境変数<TT
CLASS="ENVAR"
>OPENSSL_CONF</TT
>を希望する設定ファイルの名前に設定することにより変更可能です。
  </P
><P
><SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>は、強度が異なる、多くの暗号化および認証用のアルゴリズムをサポートします。
暗号の一覧は<SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>設定ファイル内で指定することができますが、<TT
CLASS="FILENAME"
>postgresql.conf</TT
>内の<A
HREF="runtime-config-connection.html#GUC-SSL-CIPHERS"
>ssl_ciphers</A
>を変更することで、データベースサーバで使用される暗号を指定することができます。
  </P
><DIV
CLASS="NOTE"
><BLOCKQUOTE
CLASS="NOTE"
><P
><B
>&#27880;&#24847;: </B
><TT
CLASS="LITERAL"
>NULL-SHA</TT
>または<TT
CLASS="LITERAL"
>NULL-MD5</TT
>暗号を使用して暗号化のオーバーヘッドなしで認証を行うことが可能です。
しかし、中間者はクライアントサーバ間の通信を読み取り中継することができます。
また、暗号化のオーバーヘッドは認証のオーバーヘッドと比べると最小です。
こうした理由によりNULL暗号は推奨しません。
   </P
></BLOCKQUOTE
></DIV
><P
><ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>モードを始めるには、<TT
CLASS="FILENAME"
>server.crt</TT
>および<TT
CLASS="FILENAME"
>server.key</TT
>ファイルがサーバのデータディレクトリに存在しなければなりません。
これらのファイルにはサーバ証明書と秘密キーがそれぞれ含まれます。
Unixシステムでは、<TT
CLASS="FILENAME"
>server.key</TT
>の権限は所有者以外からのアクセスを許可してはなりません。
これは<TT
CLASS="COMMAND"
>chmod 0600 server.key</TT
>というコマンドで実現できます。
秘密キーがパスフレーズで保護されている場合、サーバはパスフレーズの入力を促し、入力されるまでは起動しません。
  </P
><P
>サーバ証明書がクライアントで直接信頼している認証局ではなく、<SPAN
CLASS="QUOTE"
>"中間"</SPAN
>認証局により署名されている場合があります。
こうした証明書を使用するために、<TT
CLASS="FILENAME"
>server.crt</TT
>ファイルに署名した認証局の証明書と、クライアントで直接信頼している<SPAN
CLASS="QUOTE"
>"ルート"</SPAN
>認証局までその親となる認証局の証明書を追加してください。
<TT
CLASS="FILENAME"
>server.crt</TT
>に複数の証明書が含まれる場合はすべて、ルート証明書を含めなければなりません。
  </P
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="SSL-CLIENT-CERTIFICATES"
>17.9.1. クライアント証明書の使用</A
></H2
><P
>   
クライアントに信頼できる証明書を要求するためには、信頼する認証局（<ACRONYM
CLASS="ACRONYM"
>CA</ACRONYM
>）の証明書をデータディレクトリ内の<TT
CLASS="FILENAME"
>root.crt</TT
>ファイルに記述し、<TT
CLASS="FILENAME"
>pg_hba.conf</TT
>内の適切な<TT
CLASS="LITERAL"
>hostssl</TT
>行（複数もあり）に<TT
CLASS="LITERAL"
>clientcert</TT
>パラメータを1に設定します。
その後、SSL接続起動時にクライアントからの証明書が要求されます。
（クライアントにある証明書の設定方法については<A
HREF="libpq-ssl.html"
>&#38917;31.17</A
>を参照してください。）
サーバは、クライアントの証明書が信頼する認証局のいずれかにより署名されていることを検証します。
<TT
CLASS="FILENAME"
>root.crl</TT
>ファイルが存在する場合、証明失効リスト（CRL）項目も検査されます。
（SSL証明書の使用方法を示す図については<A
HREF="http://h71000.www7.hp.com/DOC/83final/BA554_90007/ch04s02.html"
TARGET="_top"
>http://h71000.www7.hp.com/DOC/83final/BA554_90007/ch04s02.html</A
>を参照してください。）
  </P
><P
>  
<TT
CLASS="FILENAME"
>pg_hba.conf</TT
>の中の<TT
CLASS="LITERAL"
>clientcert</TT
>オプションはすべての認証方式に対して有効ですが、<TT
CLASS="LITERAL"
>hostssl</TT
>として指定された行のみに対してです。
<TT
CLASS="LITERAL"
>clientcert</TT
>が指定されていない、または、0と設定されている場合でも、<TT
CLASS="FILENAME"
>root.crt</TT
>ファイルが存在すれば、サーバは<TT
CLASS="FILENAME"
>root.crt</TT
>に対して存在するクライアント証明書の検証を行います。
しかしクライアント証明書の存在を要求しません。
  </P
><P
><TT
CLASS="FILENAME"
>root.crt</TT
>は、クライアント証明書の署名に対して信頼できるとみなしている最上位のCAを列挙していることに注意してください。
原理的には、サーバの証明書を署名したCAを列挙する必要はありませんが、ほとんどの場合、そのCAはクライアント証明書でも信頼されています。
  </P
><P
>  
クライアント証明書を設定している場合、接続の安全性を提供するとともに証明書でユーザ認証を制御できるように<TT
CLASS="LITERAL"
>cert</TT
>認証方式を使用したいと考えるかもしれません。
詳細については<A
HREF="auth-methods.html#AUTH-CERT"
>&#38917;19.3.10</A
>を参照してください。
  </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="SSL-SERVER-FILES"
>17.9.2. サーバにおけるSSL関連ファイルの利用</A
></H2
><P
><A
HREF="ssl-tcp.html#SSL-FILE-USAGE"
>&#34920;17-3</A
>にて、サーバにおけるSSLの設定に関連するファイルをまとめます。
   </P
><DIV
CLASS="TABLE"
><A
NAME="SSL-FILE-USAGE"
></A
><P
><B
>&#34920; 17-3. SSLサーバファイルの使用方法</B
></P
><TABLE
BORDER="1"
CLASS="CALSTABLE"
><COL><COL><COL><THEAD
><TR
><TH
>ファイル</TH
><TH
>内容</TH
><TH
>影響</TH
></TR
></THEAD
><TBODY
><TR
><TD
><TT
CLASS="FILENAME"
>$PGDATA/server.crt</TT
></TD
><TD
>サーバ証明書</TD
><TD
>サーバの身元を示すためにクライアントに送信します</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>$PGDATA/server.key</TT
></TD
><TD
>サーバの秘密キー</TD
><TD
>サーバ証明書が所有者によって送られたことを証明します。証明書所有者が信頼できることを意味しません。</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>$PGDATA/root.crt</TT
></TD
><TD
>信頼できる認証局</TD
><TD
>信頼する認証局により署名されたクライアント証明書か検査します。</TD
></TR
><TR
><TD
><TT
CLASS="FILENAME"
>$PGDATA/root.crl</TT
></TD
><TD
>認証局により失効された証明書</TD
><TD
>クライアント証明書はこの一覧にあってはいけません。</TD
></TR
></TBODY
></TABLE
></DIV
><P
><TT
CLASS="FILENAME"
>server.key</TT
>、<TT
CLASS="FILENAME"
>server.crt</TT
>、<TT
CLASS="FILENAME"
>root.crt</TT
>、<TT
CLASS="FILENAME"
>root.crl</TT
>ファイルは、サーバ起動時にのみ検査されます。
ですので、これらのファイルの変更を有効にするためにはサーバを再起動する必要があります。
   </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="SSL-CERTIFICATE-CREATION"
>17.9.3. 自己署名証明書の作成</A
></H2
><P
>サーバ用の自己署名証明書を簡単に作るためには下記の<SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>コマンドを使ってください。
</P><PRE
CLASS="PROGRAMLISTING"
>openssl req -new -text -out server.req</PRE
><P>
<SPAN
CLASS="APPLICATION"
>openssl</SPAN
>から出される質問に答えてください。
この時、<SPAN
CLASS="QUOTE"
>"Common Name"</SPAN
>には確実にローカルホスト名を入力してください。
チャレンジパスワードは空白でも構いません。 
このプログラムはパスフレーズで保護されたキーを生成しますが、4文字以下のパスフレーズは認められません。
パスフレーズを削除するためには（サーバの自動起動を行いたいのであれば）、下記のコマンドを実行してください。
</P><PRE
CLASS="PROGRAMLISTING"
>openssl rsa -in privkey.pem -out server.key
rm privkey.pem</PRE
><P>
既存のキーのロックを外すために、古いパスフレーズを入力します。
そして、下記を実行してください。
</P><PRE
CLASS="PROGRAMLISTING"
>openssl req -x509 -in server.req -text -key server.key -out server.crt</PRE
><P>
このように、証明書を自己署名の証明書にして、キーと証明書とをサーバが検索する場所にコピーします。
サーバは、もしこのファイルがこれよりもゆるい権限の場合拒否するので、最後に以下を行います。
</P><PRE
CLASS="PROGRAMLISTING"
>chmod og-rwx server.key</PRE
><P>
サーバの秘密キーおよび証明書を作成するための詳しい方法については<SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>の文書を参照してください。
   </P
><P
>自己署名証明書を試験のために使用することはできますが、クライアントがサーバの身元を検証できるように、運用時は（グローバルな<ACRONYM
CLASS="ACRONYM"
>CA</ACRONYM
>の1つまたはローカルな認証局のいずれかの）認証局（<ACRONYM
CLASS="ACRONYM"
>CA</ACRONYM
>）により署名された証明書を使用すべきです。
もしすべてのクライアントが組織においてローカルであれば、ローカル<ACRONYM
CLASS="ACRONYM"
>CA</ACRONYM
>の使用が推奨されます。
   </P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="encryption-options.html"
ACCESSKEY="P"
>&#21069;&#12398;&#12506;&#12540;&#12472;</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>&#12507;&#12540;&#12512;</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="ssh-tunnels.html"
ACCESSKEY="N"
>&#27425;&#12398;&#12506;&#12540;&#12472;</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>暗号化オプション</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="runtime.html"
ACCESSKEY="U"
>&#19978;&#12395;&#25147;&#12427;</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><SPAN
CLASS="APPLICATION"
>SSH</SPAN
>トンネルを使った安全なTCP/IP接続</TD
></TR
></TABLE
></DIV
></BODY
></HTML
></div>
