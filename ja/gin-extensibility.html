<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>拡張性</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version "><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 9.1.4文書"
HREF="index.html"><LINK
REL="UP"
TITLE="GINインデックス"
HREF="gin.html"><LINK
REL="PREVIOUS"
TITLE="はじめに"
HREF="gin-intro.html"><LINK
REL="NEXT"
TITLE="実装"
HREF="gin-implementation.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=euc-jp"><META
NAME="creation"
CONTENT="2012-06-16T03:12:10"></HEAD
><BODY
CLASS="SECT1"
><script type="text/javascript">
var mod_layout = 'test';
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-50659-6");
pageTracker._trackPageview();
</script>
<style>
body{margin:0;}
#lay_body{margin:8px;}
#lay_header{margin:0 0 4px 0;border:0;padding:0;}
#lay_header .b1{border-bottom:#cef solid 1px;}
#lay_header .b2{border-bottom:#8df solid 1px;}
#lay_header .b3{border-bottom:#4bf solid 1px;padding:5px 5px 3px 5px;background:#0af;text-align:center;color:#fff;}
#lay_header a{text-decoration:none;color:#fff;font-weight:bold;}
#lay_header a:hover{text-decoration:underline;}
</style>
<div id="lay_header"><div class="b1"><div class="b2"><div class="b3">
<a href="http://lets.postgresql.jp/" target="_blank">PostgreSQLポータルサイト ＜Let's Postgres＞ http://lets.postgresql.jp/</a><br>
入門から運用、チューニングノウハウ、新機能の解説など、幅広い内容の技術解説記事をお読みいただけます。
</div></div></div></div>
<div id="lay_body">
<DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="5"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>PostgreSQL 9.1.4文書</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="はじめに"
HREF="gin-intro.html"
ACCESSKEY="P"
>&#21069;&#12398;&#12506;&#12540;&#12472;</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="GINインデックス"
HREF="gin.html"
>&#24059;&#25147;&#12375;</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>&#31532; 54&#31456;GINインデックス</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="top"
><A
TITLE="GINインデックス"
HREF="gin.html"
>&#26089;&#36865;&#12426;</A
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="top"
><A
TITLE="実装"
HREF="gin-implementation.html"
ACCESSKEY="N"
>&#27425;&#12398;&#12506;&#12540;&#12472;</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="GIN-EXTENSIBILITY"
>54.2. 拡張性</A
></H1
><P
><ACRONYM
CLASS="ACRONYM"
>GIN</ACRONYM
>インタフェースは高度に抽象化されています。
アクセスメソッド実装者に要求されることは、アクセスするデータ型の意味を実装することだけです。
<ACRONYM
CLASS="ACRONYM"
>GIN</ACRONYM
>層自体が同時実行性、ログ処理、ツリー構造の検索処理に関する注意を行います。
 </P
><P
><ACRONYM
CLASS="ACRONYM"
>GIN</ACRONYM
>アクセスメソッドを動作させるために取ることは、4つ（または5つ）のユーザ定義関数を実装することだけです。
これは、ツリー内のキーの動作とキーとインデックス付けされる項目、インデックス可能な問い合わせ間の関係を定義します。
すなわち、<ACRONYM
CLASS="ACRONYM"
>GIN</ACRONYM
>は、一般化、コード再利用、整理されたインタフェースによる拡張性を組み合わせます。
 </P
><P
><ACRONYM
CLASS="ACRONYM"
>GIN</ACRONYM
>用の演算子クラスが提供しなければならない4つのメソッドを示します。

 <P
></P
></P><DIV
CLASS="VARIABLELIST"
><DL
><DT
><CODE
CLASS="FUNCTION"
>int compare(Datum a, Datum b)</CODE
></DT
><DD
><P
>キー（インデックス付けされる項目ではありません）を比較し、0より小さい、0、または0より大きい整数を返します。
それぞれ、最初のキーが2番目のキーより、小さい、等しい、または大きいことを示します。
NULLキーがこの関数に渡されることはありません。
      </P
></DD
><DT
><CODE
CLASS="FUNCTION"
>Datum *extractValue(Datum itemValue, int32 *nkeys,
        bool **nullFlags)</CODE
></DT
><DD
><P
>インデックス対象値に与えられる、pallocで割り当てられたキーの配列を返します。
返されるキーの数は<TT
CLASS="LITERAL"
>*nkeys</TT
>に格納しなければなりません。
キーのいずれかがNULLになるかもしれない場合、<TT
CLASS="LITERAL"
>*nkeys</TT
>論理値配列をpallocで割り当てそのアドレスを<TT
CLASS="LITERAL"
>*nullFlags</TT
>に格納し、必要に応じてNULLフラグを設定してください。
すべてのキーが非NULLであれば、<TT
CLASS="LITERAL"
>*nullFlags</TT
>をNULL（初期値）のままにすることができます。
項目がキーを含まない場合、戻り値はNULLになるかもしれません。
      </P
></DD
><DT
><CODE
CLASS="FUNCTION"
>Datum *extractQuery(Datum query, int32 *nkeys,
        StrategyNumber n, bool **pmatch, Pointer **extra_data,
        bool **nullFlags, int32 *searchMode)</CODE
></DT
><DD
><P
>問い合わせ対象の値に与えられる、pallocで割り当てられたキーの配列を返します。
つまり、<TT
CLASS="LITERAL"
>query</TT
>はインデックス可能な演算子の右辺の値です。
この左辺はインデックス対象の列です。
<TT
CLASS="LITERAL"
>n</TT
>は演算子クラス内の演算子の戦略番号です（<A
HREF="xindex.html#XINDEX-STRATEGIES"
>&#38917;35.14.2</A
>を参照）。
<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>はしばしば、<TT
CLASS="LITERAL"
>query</TT
>のデータ型とキー値を抽出するために使用しなければならないメソッドを決定するために、<TT
CLASS="LITERAL"
>n</TT
>を調べなければなりません。
返されるキーの数を<TT
CLASS="LITERAL"
>*nkeys</TT
>に格納しなければなりません。
キーのいずれかがNULLとなる可能性がある場合はまた、<TT
CLASS="LITERAL"
>*nkeys</TT
>個の論理値の配列をpallocで割り当て、<TT
CLASS="LITERAL"
>*nullFlags</TT
>にそのアドレスを格納し、必要に応じてNULLフラグを設定してください。
すべてのキーが非NULLならば<TT
CLASS="LITERAL"
>*nullFlags</TT
>はヌル（初期値）のままにしておくことができます。
<TT
CLASS="LITERAL"
>query</TT
>がキーを含まない場合、戻り値をNULLにすることができます。
      </P
><P
><TT
CLASS="LITERAL"
>searchMode</TT
>は出力引数です。
これにより<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>は検索がどのように行われるかの詳細を指定することができます。
<TT
CLASS="LITERAL"
>*searchMode</TT
>が<TT
CLASS="LITERAL"
>GIN_SEARCH_MODE_DEFAULT</TT
>（呼び出し前にこの値に初期化されます。）に設定された場合、返されるキーの少なくとも１つに一致する項目が合致候補とみなされます。
<TT
CLASS="LITERAL"
>*searchMode</TT
>が<TT
CLASS="LITERAL"
>GIN_SEARCH_MODE_INCLUDE_EMPTY</TT
>に設定された場合、少なくとも１つの一致するキーを含む項目に加え、キーをまったく含まない項目が合致候補とみなされます。
（このモードは例えば何のサブセットかを求める演算子を実装する際に有用です。）
<TT
CLASS="LITERAL"
>*searchMode</TT
>が<TT
CLASS="LITERAL"
>GIN_SEARCH_MODE_ALL</TT
>に設定された場合、返されるキーのいずれかに一致するかどうかは関係なく、インデックス内の非NULLの項目すべてが合致候とみなされます。
（このモードは、基本的にインデックス全体のスキャン処理が必要ですので、他の２つの選択肢と比べてかなり低速になります。
しかし境界条件を正確に実装するためにこれが必要になるかもしれません。
おそらく、このモードを必要とする演算子はほとんどの場合、GIN演算子クラス向けに優れた候補ではありません。）
このモードを設定するために使用する記号は<TT
CLASS="FILENAME"
>access/gin.h</TT
>で定義されています。
      </P
><P
><TT
CLASS="LITERAL"
>pmatch</TT
>は部分一致が提供されている場合に使用する出力引数です。
使用するには、<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>が<TT
CLASS="LITERAL"
>*nkeys</TT
>論理値の配列を割り当て、そのアドレスを<TT
CLASS="LITERAL"
>*pmatch</TT
>に格納しなければなりません。
関連するキーが部分一致を必要とするとき、それぞれの配列要素は真に、そうでなければ偽に設定されなければなりません。
<TT
CLASS="LITERAL"
>*pmatch</TT
>がNULLに設定されている場合、GINは部分一致が必要ないと想定します。
呼び出し前に変数はNULLに初期化されますので、この引数は部分一致が提供されていない演算子クラスでは、単に無視できます。
      </P
><P
><TT
CLASS="LITERAL"
>extra_data</TT
>は、<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>が<CODE
CLASS="FUNCTION"
>consistent</CODE
>と<CODE
CLASS="FUNCTION"
>comparePartial</CODE
>メソッドに追加データを渡すことができるようにする出力引数です。
使用するには、<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>が<TT
CLASS="LITERAL"
>*nkeys</TT
>ポインタの配列を割り当て、そのアドレスを<TT
CLASS="LITERAL"
>*extra_data</TT
>に格納し、そして望まれるものは何でも個別のポインタに格納しなければなりません。
変数は呼び出し前にNULLに初期化されますので、追加データを必要としない演算子クラスでこの引数は単に無視できます。
もし<TT
CLASS="LITERAL"
>*extra_data</TT
>が設定されれば、配列全部が<CODE
CLASS="FUNCTION"
>consistent</CODE
>メソッドに、適切な要素が<CODE
CLASS="FUNCTION"
>comparePartial</CODE
>メソッドに渡されます。
      </P
></DD
><DT
><CODE
CLASS="FUNCTION"
>bool consistent(bool check[], StrategyNumber n, Datum query,
        int32 nkeys, Pointer extra_data[], bool *recheck,
        Datum queryKeys[], bool nullFlags[])</CODE
></DT
><DD
><P
>インデックス付けられた項目が戦略番号<TT
CLASS="LITERAL"
>n</TT
>を持つ問い合わせ演算子を満たす（または、recheck印が返されたときはたぶん満たすかもしれない）場合に真を返します。
<ACRONYM
CLASS="ACRONYM"
>GIN</ACRONYM
>は項目を明示的に格納しませんので、この関数はインデックス付けされた項目の値に直接アクセスすることができません。
どちらかというと、この問い合わせから取り出される指定された問い合わせで現れるキー値に関する知識が利用できるものです。
<TT
CLASS="LITERAL"
>check</TT
>配列は長さ<TT
CLASS="LITERAL"
>nkeys</TT
>であり、この<TT
CLASS="LITERAL"
>query</TT
>データに対して事前に行われた<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>が返したキーの数と同じです。
インデックス対象の項目が対応する問い合わせキーを持つ場合、<TT
CLASS="LITERAL"
>check</TT
>配列の各要素は真です。
つまり、(check[i] == TRUE)の場合、<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>の結果配列のi番目のキーがインデックス対象項目内に存在します。
元の<TT
CLASS="LITERAL"
>query</TT
>データは、<CODE
CLASS="FUNCTION"
>consistent</CODE
>メソッドがそれを調査する必要がある場合に、渡されます。
このため<TT
CLASS="LITERAL"
>queryKeys[]</TT
>および<TT
CLASS="LITERAL"
>nullFlags[]</TT
>は事前に<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>によって返されます。
<TT
CLASS="LITERAL"
>extra_data</TT
>は<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>により返された追加データ配列で、ない場合はNULLです。
      </P
><P
><CODE
CLASS="FUNCTION"
>extractQuery</CODE
>が<TT
CLASS="LITERAL"
>queryKeys[]</TT
>内でNULLキーを返す時、インデックス対象項目がNULLキーを含む場合は対応する<TT
CLASS="LITERAL"
>check[]</TT
>要素は真です、
つまり、<TT
CLASS="LITERAL"
>check[]</TT
>の意味は<TT
CLASS="LITERAL"
>IS NOT DISTINCT FROM</TT
>のようなものです。
<CODE
CLASS="FUNCTION"
>consistent</CODE
>関数は、通常の値の合致とNULL合致との違いを通知する必要がある場合、対応する<TT
CLASS="LITERAL"
>nullFlags[]</TT
>要素を検査することができます。
      </P
><P
>成功の場合、<TT
CLASS="LITERAL"
>*recheck</TT
>はヒープタプルが問い合わせ演算子に対し再検査を必要とすれば真で、インデックス検査が的確であれば偽です。
つまり、FALSEという戻り値はヒープタプルが問い合わせに合わないことを保証し、<TT
CLASS="LITERAL"
>*recheck</TT
>が付いたTRUEという戻り値はヒープタプルが問い合わせに一致する可能性があるため、それを取り出し、元のインデックス付けされた項目を直接問い合わせ演算子で評価することで再検査する必要があることを意味します。
      </P
></DD
></DL
></DIV
><P>

省略可能ですが、<ACRONYM
CLASS="ACRONYM"
>GIN</ACRONYM
>に対する演算子クラスは第5のメソッドを提供します。

  <P
></P
></P><DIV
CLASS="VARIABLELIST"
><DL
><DT
><CODE
CLASS="FUNCTION"
>int comparePartial(Datum partial_key, Datum key, StrategyNumber n,
                              Pointer extra_data)</CODE
></DT
><DD
><P
>問い合わせキーとインデックスキーの部分一致を比較します。
符号が結果を示す整数が返ります。
ゼロ未満はインデックスキーは問い合わせに一致しないが、インデックススキャンを続けるべきであることを示します。
ゼロはインデックスキーが問い合わせに一致することを示します。
ゼロより大きな値はこれ以上の一致はありえないためインデックススキャンを停止すべきであることを示します。
スキャンをいつ停止するかを決めるためにセマンテックスが必要とされる場合、部分一致問い合わせを生成した演算子の戦略番号<TT
CLASS="LITERAL"
>n</TT
>が提供されます。
また<TT
CLASS="LITERAL"
>extra_data</TT
>は<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>で作成される追加データ配列の対応する要素、もしなければNULLです。
NULLキーがこの関数に渡されることはありません。
      </P
></DD
></DL
></DIV
><P>
 </P
><P
><SPAN
CLASS="QUOTE"
>"部分一致"</SPAN
>問い合わせをサポートするためには、演算子クラスは<CODE
CLASS="FUNCTION"
>comparePartial</CODE
>メソッドを提供しなければなりません。
またその<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>は、部分一致問い合わせであった時に<TT
CLASS="LITERAL"
>pmatch</TT
>パラメータを設定しなければなりません。
詳細については<A
HREF="gin-implementation.html#GIN-PARTIAL-MATCH"
>&#38917;54.3.2</A
>を参照してください。
 </P
><P
>上記の各種<TT
CLASS="LITERAL"
>Datum</TT
>値の実データ型は、演算子クラスに依存して変動します。
<CODE
CLASS="FUNCTION"
>extractValue</CODE
>に渡される項目値は常に演算子クラスの入力型であり、キー値はすべてそのクラスの<TT
CLASS="LITERAL"
>STORAGE</TT
>型でなければなりません。
<CODE
CLASS="FUNCTION"
>extractQuery</CODE
>および<CODE
CLASS="FUNCTION"
>consistent</CODE
>に渡される<TT
CLASS="LITERAL"
>query</TT
>引数は、戦略番号によって識別されるクラスのメンバ演算子の右辺入力型として指定されたものになります。
正しい型のキー値がそこから抽出できる限り、これは項目の型と同じである必要はありません。
 </P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="gin-intro.html"
ACCESSKEY="P"
>&#21069;&#12398;&#12506;&#12540;&#12472;</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>&#12507;&#12540;&#12512;</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="gin-implementation.html"
ACCESSKEY="N"
>&#27425;&#12398;&#12506;&#12540;&#12472;</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>はじめに</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="gin.html"
ACCESSKEY="U"
>&#19978;&#12395;&#25147;&#12427;</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>実装</TD
></TR
></TABLE
></DIV
></BODY
></HTML
></div>
